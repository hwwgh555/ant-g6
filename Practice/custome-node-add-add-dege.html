<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>Tutorial Demo--G6</title>
</head>

<body>
    <div id="container"></div>

    <script type="text/javascript"
        src="https://gw.alipayobjects.com/os/antv/pkg/_antv.g6-3.7.1/dist/g6.min.js"></script>
    <script>
        const $container = document.querySelector('#container');
        /*
            当前只有点击 红块 以外才能 出现edge TODO: // 如何只在特定条件下出现edge       
        */

        G6.registerBehavior('addEdge', {
            getEvents() {
                return {
                    'node:dragstart': 'onNodeDragstart',
                    //'edge:mouseleave': 'onEdgeMouseleave', // 这里待完善，有时候出现不消失的情况 TODO:
                    drag: 'onNodeMousemouse',
                    'node:drop': 'onNodeDrop',
                    dragend: 'onDragend'
                }
            },
            onNodeDragstart(ev) {
                const graph = this.graph
                const node = ev.item
                const model = node.getModel()
                this.edge = graph.addItem('edge', {
                    source: model.id,
                    target: model.id,
                })
                // 新加了一个id作为对比
                this.source = model.id
                this.addingEdge = true
            },
            // 模仿antd内置的库的 create-edge处理
            onDragend(ev) {
                const { item } = ev
                if (!item || item.getID() === this.source || item.getType() !== 'node') {
                    if (this.addingEdge && this.edge) {
                        this.graph.removeItem(this.edge)
                        this.edge = null
                        this.addingEdge = false
                    }
                }
            },
            onNodeMousemouse(ev) {
                if (this.edge && this.addingEdge) {
                    this.graph.updateItem(this.edge, {
                        target: {
                            x: ev.x,
                            y: ev.y,
                        }
                    })
                }
            },
            onNodeDrop(ev) {
                if (this.edge && this.addingEdge) {
                    this.graph.updateItem(this.edge, {
                        target: ev.item.getModel().id
                    })
                    this.addingEdge = false
                    this.edge = null
                    console.log('xxx', this.addingEdge, this.edge)
                }
            }
        })

        G6.registerNode('myNode', {
            draw(cfg, group) {
                const keyShape = group.addShape('rect', {
                    attrs: {
                        fill: 'red',
                        width: 120,
                        height: 60,
                    },
                    name: 'rect-shape'
                })
                if (cfg.label) {
                    group.addShape('text', {
                        attrs: {
                            text: cfg.label,
                            x: 0,
                            y: 0,
                            fontSize: 14,
                            textAlign: 'center',
                            textBaseline: 'middle',
                            fill: '#0000D9',
                        },
                        name: 'text-shape'
                    })
                }
                group.addShape('rect', {
                    attrs: {
                        x: 30,
                        y: 30,
                        fill: 'blue',
                        width: 30,
                        height: 30,
                    },
                    name: 'rect-shape'
                })
                group.addShape('rect', {
                    attrs: {
                        x: 70,
                        y: 30,
                        fill: 'blue',
                        width: 30,
                        height: 30,
                    },
                    name: 'rect-shape'
                })
                return keyShape
            },
            update(cfg) {

            },
            setState() {

            }
        })

        const graph = new G6.Graph({
            container: 'container',
            width: $container.scrollWidth,
            height: $container.scrollHeight || 500,
            defaultNode: {
                type: 'rect'
            },
            layout: {
                type: 'dagre',
                rankdir: 'TB',
            },
            modes: {
                default: ['addEdge']
            }
        })
        const data = {
            nodes: [
                {
                    id: 'node1',
                    label: 'node1',
                    size: [100, 50],
                    type: 'myNode'
                },
                {
                    id: 'node2',
                    label: 'node2',
                    size: [100, 50],
                    type: 'myNode'
                },
            ]
        }
        graph.data(data)
        graph.render()
    </script>
</body>

</html>